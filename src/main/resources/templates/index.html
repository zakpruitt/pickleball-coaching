<!DOCTYPE html>
<html>

<head>
    <title>Payment Form</title>
</head>

<body>
<form id="payment-form">
    <label for="firstName">First Name:</label>
    <input type="text" id="firstName" name="firstName" required><br>
    <label for="lastName">Last Name:</label>
    <input type="text" id="lastName" name="lastName" required><br>
    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required><br>
    <label for="note">Note:</label>
    <textarea id="note" name="note"></textarea><br>
    <label for="package">Package:</label>
    <select id="package" name="package" required>
        <option value="40">Basic - $40</option>
        <option value="80">Premium - $80</option>
    </select><br>
    <label for="video">Upload Video:</label>
    <input type="file" id="video" name="video" accept="video/*" required><br>
    <button type="submit">Submit</button>
</form>

<script src="https://js.stripe.com/v3/"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    $(document).ready(function () {
        $('#payment-form').submit(async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const videoFile = formData.get('video');

            const orderData = await createOrder(formData);
            if (!orderData) return;

            const videoData = await uploadVideo(videoFile, orderData.id);
            if (!videoData) return;

            const paymentData = await createPayment(formData, orderData);
            if (!paymentData) return;

            storeOrderDetails(orderData.id, paymentData.id);
            redirectToPayment(paymentData.stripePaymentUrl);
        });

        async function createOrder(formData) {
            const order = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                note: formData.get('note'),
                packageSelected: formData.get('package')
            };

            try {
                const orderResponse = await $.ajax({
                    url: 'http://localhost:8080/api/orders/create',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(order)
                });
                return orderResponse;
            } catch (error) {
                alert('Order creation failed. Please try again.');
                return null;
            }
        }

        async function uploadVideo(videoFile, customerOrderId) {
            const videoFormData = new FormData();
            videoFormData.append('file', videoFile);
            videoFormData.append('customerOrderId', customerOrderId);

            try {
                const videoResponse = await $.ajax({
                    url: 'http://localhost:8080/api/videos/upload',
                    type: 'POST',
                    processData: false,
                    contentType: false,
                    data: videoFormData
                });
                return videoResponse;
            } catch (error) {
                alert('Video upload failed. Please try again.');
                return null;
            }
        }

        async function createPayment(formData, orderData) {
            const payment = {
                currencyAmount: formData.get('package') === '40' ? 4000 : 8000,
                currencyType: 'usd',
                customerOrder: orderData
            };

            try {
                const paymentResponse = await $.ajax({
                    url: 'http://localhost:8080/api/payments/create',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payment)
                });
                return paymentResponse;
            } catch (error) {
                alert('Payment failed. Please try again.');
                return null;
            }
        }

        function storeOrderDetails(orderId, paymentId) {
            sessionStorage.setItem('customerOrderId', orderId);
            sessionStorage.setItem('paymentId', paymentId);
        }

        function redirectToPayment(stripePaymentUrl) {
            window.location.href = stripePaymentUrl;
        }
    });
</script>
</body>

</html>
